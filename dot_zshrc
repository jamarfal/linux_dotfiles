# --- 0. CONFIGURACIÓN DEL SISTEMA (M2/BREW) ---
eval "$(/opt/homebrew/bin/brew shellenv)"

# --- 1. VARIABLES DE ENTORNO ---
export EDITOR='nvim'
export VISUAL='nvim'
export LANG=en_US.UTF-8

# Java & Android (SDKMAN)
export SDKMAN_DIR="$HOME/.sdkman"
[[ -s "$HOME/.sdkman/bin/sdkman-init.sh" ]] && source "$HOME/.sdkman/bin/sdkman-init.sh"

# --- 2. HERRAMIENTAS DE RENDIMIENTO (RUST) ---
eval "$(starship init zsh)" # Prompt
eval "$(zoxide init zsh)"   # Navegación (z)

# --- 3. CONFIGURACIÓN DE COMPLETADO (ZSH-COMPLETIONS) ---
# Añadir completados de Brew al fpath
if type brew &>/dev/null; then
  FPATH=$(brew --prefix)/share/zsh-completions:$FPATH
fi

# Inicializar sistema de completado (OBLIGATORIO para que funcionen los plugins)
autoload -Uz compinit
compinit

# --- 4. ALIAS Y HERRAMIENTAS ---
# Sistema
alias zconfig="$EDITOR ~/.zshrc" # Usa nvim en lugar de TextEdit
alias reload="source ~/.zshrc && echo '✅ Zsh recargado'"

# Git
alias g="git"
alias gst="git status"
alias gco="git checkout"
alias gcb="git checkout -b"
alias gp="git pull"
alias gl="git log --oneline --graph --decorate --all"
alias lg="lazygit"

# Android Dev
alias gw="./gradlew"
alias gwclean="./gradlew clean"
alias studio="open -a /Applications/Android\ Studio.app ."
alias scrcpy="scrcpy --max-size 1024 --bit-rate 2M --max-fps 60" # Optimizado para fluidez

# Modern Unix (Eza & Bat)
alias ls="eza --icons --git --header --group-directories-first"
alias ll="eza --icons --git --header --group-directories-first -l"
alias la="eza --icons --git --header --group-directories-first -la"
alias tree="eza --icons --tree"
alias cat="bat"

# --- 5. FUNCIONES EXTRA ---
# Copiar rama actual con Ctrl + G
function copy_git_branch() {
    local branch=$(git branch --show-current 2>/dev/null)
    if [ -n "$branch" ]; then
        echo -n "$branch" | pbcopy
        zle -M "✅ Rama copiada: $branch"
    else
        zle -M "❌ No es un repo Git"
    fi
    zle reset-prompt
}
zle -N copy_git_branch
bindkey '^g' copy_git_branch

function y() {
	local tmp="$(mktemp -t "yazi-cwd.XXXXXX")"
	yazi "$@" --cwd-file="$tmp"
	if cwd="$(cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
		builtin cd -- "$cwd"
	fi
	rm -f -- "$tmp"
}

# --- 6. HISTORIAL Y BÚSQUEDA ---
HISTSIZE=10000
SAVEHIST=10000
setopt HIST_IGNORE_DUPS
setopt SHARE_HISTORY

# FZF (Búsqueda difusa)
source <(fzf --zsh)

# --- 7. PLUGINS VISUALES (AL FINAL) ---
if type brew &>/dev/null; then
  # Autosuggestions (Texto fantasma)
  source $(brew --prefix)/share/zsh-autosuggestions/zsh-autosuggestions.zsh
  
  # Syntax Highlighting (SIEMPRE EL ÚLTIMO)
  source $(brew --prefix)/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
fi

# --- ARREGLO DE TECLAS (Keybindings) ---

# Activar atajos estándar tipo Emacs (Ctrl+A, Ctrl+E)
bindkey -e

# Asegurar que las teclas funcionan explícitamente
bindkey '^A' beginning-of-line       # Ctrl+A -> Inicio
bindkey '^E' end-of-line             # Ctrl+E -> Final
bindkey '^U' backward-kill-line      # Ctrl+U -> Borrar hasta el inicio
bindkey '^K' kill-line               # Ctrl+K -> Borrar hasta el final
bindkey '^R' history-incremental-search-backward # Ctrl+R -> Buscar historial

# Arreglar Flechas, Inicio y Fin (por si acaso)
bindkey "^[[H" beginning-of-line
bindkey "^[[F" end-of-line
bindkey "^[OH" beginning-of-line
bindkey "^[OF" end-of-line
